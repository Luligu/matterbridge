<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Markdown Output</title>
  <link rel="icon" type="image/svg+xml" href="matterbridge.svg">
  <style>
    body {
      font-family: Roboto, Arial, 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      margin: 40px;
    }
    h1, h2, h3 {
      font-family: Roboto, Arial, 'Helvetica Neue', sans-serif;
    }
  </style>
</head>
<body>
<h1><img src="frontend/public/matterbridge.svg" alt="Matterbridge Logo" width="64px" height="64px">&nbsp;&nbsp;&nbsp;Matterbridge systemd configuration with local global node_modules</h1>
<p><a href="https://www.npmjs.com/package/matterbridge"><img src="https://img.shields.io/npm/v/matterbridge.svg" alt="npm version"></a>
<a href="https://www.npmjs.com/package/matterbridge"><img src="https://img.shields.io/npm/dt/matterbridge.svg" alt="npm downloads"></a>
<a href="https://hub.docker.com/r/luligu/matterbridge"><img src="https://img.shields.io/docker/v/luligu/matterbridge?label=docker%20version&sort=semver" alt="Docker Version"></a>
<a href="https://hub.docker.com/r/luligu/matterbridge"><img src="https://img.shields.io/docker/pulls/luligu/matterbridge.svg" alt="Docker Pulls"></a>
<img src="https://github.com/Luligu/matterbridge/actions/workflows/build.yml/badge.svg" alt="Node.js CI">
<img src="https://github.com/Luligu/matterbridge/actions/workflows/codeql.yml/badge.svg" alt="CodeQL">
<a href="https://codecov.io/gh/Luligu/matterbridge"><img src="https://codecov.io/gh/Luligu/matterbridge/branch/main/graph/badge.svg" alt="codecov"></a></p>
<p><a href="https://www.npmjs.com/package/matter-history"><img src="https://img.shields.io/badge/powered%20by-matter--history-blue" alt="power by"></a>
<a href="https://www.npmjs.com/package/node-ansi-logger"><img src="https://img.shields.io/badge/powered%20by-node--ansi--logger-blue" alt="power by"></a>
<a href="https://www.npmjs.com/package/node-persist-manager"><img src="https://img.shields.io/badge/powered%20by-node--persist--manager-blue" alt="power by"></a></p>
<hr>
<h1>Advanced configuration</h1>
<h2>Run matterbridge as a daemon with systemctl (Linux only) with local global node_modules</h2>
<p>The advantage of this setup is that the global node_modules are private for the user and sudo is not required.</p>
<p>The service runs rootless like the current user.</p>
<p>The storage position is compatible with the traditional setup (~/Matterbridge ~/.matterbridge ~/.mattercert).</p>
<h3>First create the Matterbridge directories and set the correct permissions</h3>
<p>This will create the required directories if they don&#39;t exist</p>
<pre><code class="language-bash">cd ~
sudo systemctl stop matterbridge                                                        # Γ£à Safe precaution if matterbridge was already running with the traditional setup
sudo npm uninstall matterbridge -g                                                      # Γ£à We need to uninstall from the global node_modules
mkdir -p ~/Matterbridge ~/.matterbridge ~/.mattercert ~/.npm-global                     # Γ£à Creates all needed dirs
chown -R $USER:$USER ~/Matterbridge ~/.matterbridge ~/.mattercert ~/.npm-global         # Γ£à Ensures ownership
chmod -R 755 ~/Matterbridge ~/.matterbridge ~/.mattercert ~/.npm-global                 # Γ£à Secure permissions
NPM_CONFIG_PREFIX=~/.npm-global npm install matterbridge --omit=dev --verbose --global  # Γ£à Install matterbridge in the local global node_modules, no sudo
sudo ln -sf /home/$USER/.npm-global/bin/matterbridge /usr/local/bin/matterbridge        # Γ£à Create a link to matterbridge bin
sudo ln -sf /home/$USER/.npm-global/bin/mb_mdns /usr/local/bin/mb_mdns                  # Γ£à Create a link to mb_mdns bin
sudo ln -sf /home/$USER/.npm-global/bin/mb_coap /usr/local/bin/mb_coap                  # Γ£à Create a link to mb_coap bin
hash -r                                                                                 # Γ£à Clear bash command cache as a precaution
which matterbridge                                                                      # Γ£à Check it
matterbridge --version                                                                  # Γ£à Will output the matterbridge version
</code></pre>
<h3>Then create a systemctl configuration file for Matterbridge</h3>
<p>Create a systemctl configuration file for Matterbridge</p>
<pre><code class="language-bash">sudo nano /etc/systemd/system/matterbridge.service
</code></pre>
<p>Add the following to this file, <strong>replacing 4 times (!) USER with your user name</strong> (e.g. WorkingDirectory=/home/pi/Matterbridge, User=pi and Group=pi and Environment=&quot;NPM_CONFIG_PREFIX=/home/pi/.npm-global&quot;):</p>
<pre><code>[Unit]
Description=matterbridge
After=network.target
Wants=network.target

[Service]
Type=simple
Environment=&quot;NPM_CONFIG_PREFIX=/home/&lt;USER&gt;/.npm-global&quot;
ExecStart=matterbridge --service --nosudo
WorkingDirectory=/home/&lt;USER&gt;/Matterbridge
StandardOutput=inherit
StandardError=inherit
Restart=always
User=&lt;USER&gt;
Group=&lt;USER&gt;

[Install]
WantedBy=multi-user.target
</code></pre>
<p>If you use the frontend with <strong>-ssl</strong> -frontend 443 and get an error message: &quot;Port 443 requires elevated privileges&quot;,
add this:</p>
<pre><code>[Service]
AmbientCapabilities=CAP_NET_BIND_SERVICE
</code></pre>
<p>If you use the <strong>matterbridge-bthome</strong> plugin add this:</p>
<pre><code>[Service]
AmbientCapabilities=CAP_NET_BIND_SERVICE CAP_NET_RAW CAP_NET_ADMIN
</code></pre>
<p>Now and if you modify matterbridge.service after, run:</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl restart matterbridge.service
sudo systemctl status matterbridge.service
</code></pre>
<h3>Start Matterbridge</h3>
<pre><code class="language-bash">sudo systemctl start matterbridge
</code></pre>
<h3>Stop Matterbridge</h3>
<pre><code class="language-bash">sudo systemctl stop matterbridge
</code></pre>
<h3>Show Matterbridge status</h3>
<pre><code class="language-bash">sudo systemctl status matterbridge.service
</code></pre>
<h3>Enable Matterbridge to start automatically on boot</h3>
<pre><code class="language-bash">sudo systemctl enable matterbridge.service
</code></pre>
<h3>Disable Matterbridge from starting automatically on boot</h3>
<pre><code class="language-bash">sudo systemctl disable matterbridge.service
</code></pre>
<h3>View the log of Matterbridge in real time (this will show the log with colors)</h3>
<pre><code class="language-bash">sudo journalctl -u matterbridge.service -n 1000 -f --output cat
</code></pre>
<h3>Delete the logs older then 3 days (all of them not only the ones of Matterbridge!)</h3>
<p>Check the space used</p>
<pre><code class="language-bash">sudo journalctl --disk-usage
</code></pre>
<p>remove all log older then 3 days</p>
<pre><code class="language-bash">sudo journalctl --rotate
sudo journalctl --vacuum-time=3d
</code></pre>
<h2>Prevent the journal logs to grow</h2>
<p>If you want to make the setting permanent to prevent the journal logs to grow too much, run</p>
<pre><code class="language-bash">sudo nano /etc/systemd/journald.conf
</code></pre>
<p>add</p>
<pre><code class="language-bash">Compress=yes            # Compress logs
MaxRetentionSec=3days   # Keep logs for a maximum of 3 days.
MaxFileSec=1day         # Rotate logs daily within the 3-day retention period.
ForwardToSyslog=no      # Disable forwarding to syslog to prevent duplicate logging.
SystemMaxUse=100M       # Limit persistent logs in /var/log/journal to 100 MB.
RuntimeMaxUse=100M      # Limit runtime logs in /run/log/journal to 100 MB.
</code></pre>
<p>save it and run</p>
<pre><code class="language-bash">sudo systemctl restart systemd-journald
</code></pre>

</body>
</html>
